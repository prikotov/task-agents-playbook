# Запрос на слияние (Pull Request)

**Pull Request (PR)** — предложенный набор изменений из рабочей ветки в `master`, проходящий проверки и `Code Review`.

## Границы ответственности

- Документ описывает подготовку PR и требования к содержимому PR.
- Правила веток описаны отдельно: [Ветки (Branches)](branches.md).
- Правила коммитов описаны отдельно: [Коммиты (Commits)](commits.md).
- Как проводить ревью изменений описано отдельно: [Ревью кода (Code Review)](code-review.md).

## Правила

- Запрещены прямые правки в `master`.
- Одна задача — один PR (или одна подзадача, если задача большая).
- Не смешивай изменения из разных задач.
- Держи PR минимальным по объёму.
- Не добавляй в PR изменения “заодно”.
- Не тащи в PR форматирование без смысла и правки из других задач.
- Убирай из PR debug-код и “строительный мусор”.
- PR самодостаточный после merge в `master`.
- Не делай зависимые PR, которые по отдельности не работают.
- Не накапливай изменения в долгоживущей ветке: всё, что можно безопасно смержить в `master`, оформляй отдельным PR.
- Не проси пользователя создать PR и не ссылайся на “нет прав”.
- Не смешивай `move/rename` и последующий `refactor/behavior change`:
  - перенос/переименование/массовые механические правки — отдельный PR
  - рефакторинг и изменение поведения — отдельный PR
- Ориентир размера PR: около 600 строк `diff` (`added + deleted`).
- Если PR больше — разбей его или объясни причину.
- Если PR больше — добавь навигацию по ревью.
- PR заглушек/архитектуры может быть больше при формальных изменениях.
- PR с новой логикой держи особенно компактным.
- Значимые изменения сопровождай тестами соответствующего уровня.
- Любое временное решение или архитектурный компромисс помечай в коде и описывай в PR.

## Создание PR

- Определи, это `docs-only` правка или нет.
- Если это не `docs-only` — **обязательно** запусти проверки `make check`.
- `make check` должен быть зелёный.
- Если это `docs-only` — укажи в PR, что `make check` пропущен.
- Сделай self-review: [Ревью кода (Code Review)](code-review.md).
- Перед созданием PR (до `gh pr create`) синхронизируй артефакты задачи в `todo/`: переведи `Статус` в `done`, перенеси файл в `todo/done/`, актуализируй ссылки в Epic/зависимых задачах.
- Используй CLI-инструменты: `git`, `gh`.
- Сделай push: `git push -u origin HEAD`.
- Создай PR через `gh pr create` (используй флаг `--head $(git branch --show-current)` для исключения интерактива).
- Тело PR передавай через `gh pr create --body-file`.
- Предпочитай `--body-file -` (stdin) или файл в `tmp/`.
- После создания PR обнови поле `PR` в задаче (`todo/...`) ссылкой/номером созданного PR.

## Оформление PR

- Заголовок PR: английский, кратко отражает суть.
- Описание PR включает:
  - если задачи в `todo/` ещё нет — оформи её по правилам: [todo/AGENTS.md](../todo/AGENTS.md).
  - постановку задачи из prompt
  - постановку задачи из `todo/<ID>.todo.md` (если есть)
  - цель и причина изменений 
  - основные модули и файлы
  - особые случаи / breaking changes
  - ссылка на задачу/issue
  - проверки и результат (краткое саммари `stdout` / ссылка на CI job)
- Метка AI-агента **обязательна** (label в GitHub).
- Выбирай метку AI-агента по использованному инструменту.
  - `gemini-cli` — Gemini CLI
  - `codex-cli` — Codex из локального CLI (для Codex: используй по умолчанию, если сессия запущена пользователем из CLI)
  - `codex` — Codex из cloud-окружения (для Codex: используй только если работа явно идёт не из локального CLI)
  - `opencode` — OpenCode
  - `roocode` — Roo Code
  - `kilocode` — Kilo Code
  - Если нужной метки нет — добавь её в репозиторий.
- Не добавляй несколько “агентских” меток в один PR:
- Укажи метку при создании: `gh pr create --label "<agent-label>"`.
- Или добавь метку после: `gh pr edit <PR_NUMBER> --add-label "<agent-label>"`.

## После merge

- После merge (после аппрува пользователем) переключись на `master`.
- Обнови `master`: `git pull origin master`.
- Удали рабочую ветку локально и в `origin`.
- Проверь, что рабочее дерево чистое: `git status`.
- Предложи пользователю следующую задачу.
