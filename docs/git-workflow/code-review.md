# Ревью кода (Code Review)

**Ревью кода (Code Review)** — процесс проверки изменений в `Pull Request`, цель которого:

- убедиться, что решена поставленная задача
- предотвратить попадание неработающего кода в production
- не допустить роста технического долга

## Границы ответственности

- Ревью отвечает за качество и корректность предлагаемых изменений в рамках задачи и заявленных границ PR.
- Правила оформления PR находятся в [Pull Request (PR)](pull-request.md).
- В ревью проверяется соответствие этим правилам.

## Общие правила

- Прочитай описание `Pull Request`.
- Найди постановку задачи в описании `Pull Request`.
- Прочитай постановку задачи полностью.
- Источник постановки задачи: prompt или `todo/<ID>.todo.md`.
- Зафиксируй ожидаемый результат и критерии приёмки.
- Проверь PR по правилам: [Pull Request (PR)](pull-request.md).
- Несоответствия правилам PR — это `blocking`.
- Проверь результаты проверок (CI или `make check`).
- Прочитай diff целиком.
- Если правила нет или оно неоднозначно — зафиксируй это и предложи отдельную задачу на уточнение `docs/conventions/*`.
- Проверяй только в рамках задачи и заявленных границ PR.
- Не добавляй “улучшения ради улучшений” в текущий PR.
- Пиши замечания конкретно: что / почему / что изменить.
- Маркируй замечания: `blocking`, `suggestion`, `nit`.
- Если затронуты архитектура/подход/новые абстракции — запроси согласование у пользователя до продолжения реализации.

## Чеклист ревью

### Соответствие решения задаче

- [ ] Решает ли код задачу?
- [ ] Нет ли ничего лишнего, что к задаче не относится?
- [ ] Ломает ли код что-либо (публичные интерфейсы, обратная совместимость, UX, API)?
- [ ] Затрагивает ли код другие задачи/модули/сценарии без необходимости?

### Реализация

- [ ] Есть ли опечатки, неверные имена, вводящие в заблуждение формулировки?
- [ ] Есть ли корректная обработка `null`/пустых значений/отсутствующих ключей?
- [ ] Работает ли в “крайних” состояниях и с неожиданными данными?
- [ ] Для внешних сервисов учтены ошибки и недоступность.
- [ ] Для внешних сервисов выставлены таймауты.
- [ ] Ретраи ограничены и используются только для идемпотентных операций.

### Тесты и проверяемость

- [ ] Изменения покрыты тестами нужного уровня (`Unit`/`Integration`/`E2E`) там, где это ожидаемо.
- [ ] Тесты проверяют поведение, а не детали реализации.
- [ ] Нет нестабильных (flaky) тестов.
- [ ] Тесты не зависят от реальных внешних сервисов.
- [ ] Есть способ локально воспроизвести изменение (шаги/команды/fixtures в описании PR).

### Архитектура и модульность

- [ ] Соблюдены границы модулей и слоёв (Domain/Application/Infrastructure/Integration/Presentation).
- [ ] Контроллеры делегируют: валидация входа → use case → формирование ответа.
- [ ] Не добавлены нежелательные зависимости между слоями/модулями.

### Конфигурация и миграции

- [ ] Изменения в config/env описаны в PR.
- [ ] Значения по умолчанию безопасны.
- [ ] Секреты не закоммичены.
- [ ] Новые переменные перечислены в описании PR.
- [ ] Doctrine migrations названы `VersionYYYYMMDDHHMMSS.php` (UTC).
- [ ] Doctrine migrations минимальны.
- [ ] Описан безопасный порядок выкладки (в т.ч. для больших таблиц/индексов).

### Технический долг

- [ ] Понятен ли код (названия, структура, ответственность)?
- [ ] Не сложнее ли решение, чем требует задача?
- [ ] Нет ли костылей без явной причины и описания?
- [ ] Нет ли дублирования и “магии” (скрытых сайд-эффектов, неочевидных правил)?
- [ ] Новые понятия/абстракции/подходы оправданы? Лучше ли переиспользовать существующие?
- [ ] Новые внешние зависимости оправданы и минимальны?
- [ ] В БД не хранится информация о коде (имена классов/переменных/констант) без веской причины?
- [ ] Типизация проверяется статическим анализом (Psalm).
- [ ] Нет избыточного `mixed`.
- [ ] Типы параметров/возвратов/свойств корректны.
- [ ] PHPDoc уточняет типы коллекций (например, `list<string>`, `array<int, Foo>`).
- [ ] Соблюдены KISS/SOLID/DRY/GRASP там, где это уместно.
- [ ] Низкая связанность (coupling) и высокая связность (cohesion) внутри компонентов.

### Производительность

- [ ] Запросы к БД оптимальны: нет N+1, используются индексы, нет лишних запросов.
- [ ] Нет долгих/тяжёлых операций в web-request.
- [ ] Долгие/ресурсоёмкие операции вынесены в `Messenger`/worker.
- [ ] На страницах не публикуется лишний JavaScript/CSS, нет ненужных ассетов.
- [ ] Решение выдержит рост нагрузки/объёма данных (по памяти/времени/IO).

### Безопасность

- [ ] XSS: экранируются ли переменные в шаблонах/HTML?
- [ ] SQL Injection: не собирается ли SQL вручную без параметризации?
- [ ] Права доступа: проверены ли авторизация/роли/доступы на всех state-changing endpoint?
- [ ] В репозиторий не попали секреты и персональные данные (токены/ключи/пароли, реальные email/телефоны и т.п.).

### Соблюдение правил и соглашений

- [ ] Соблюдены `Code Conventions`: [docs/conventions/index.md](../conventions/index.md).
- [ ] Соблюдён `Code Style`.
- [ ] См. [docs/conventions/principles/code_style.md](../conventions/principles/code_style.md).

## Результат ревью

- Если есть вопросы по задаче или ожидаемому поведению — попроси уточнить описание `Pull Request`.
- Если есть вопросы по публичным интерфейсам — задай вопросы в комментарии к PR.
- Публичные интерфейсы: API, маршруты, DTO, события.
- Если есть `blocking` замечания — запроси правки (`Request changes`) и перечисли требования к изменениям.
- Если критичных проблем нет — можно `Approve`.
