# Коммиты (Commits)

**Коммит (commit)** — атомарная фиксация изменения с сообщением, описывающим намерение (intent).

## Границы ответственности

- Документ описывает формат сообщений коммитов.
- Правила веток описаны отдельно: [Ветки (Branches)](branches.md).
- Правила PR описаны отдельно: [Pull Request (PR)](pull-request.md).

## Формат Conventional Commits

```
<type>(<scope>): <subject>
```

Где:
- `<type>` — тип изменения (`fix`, `feat`, `refactor`, …).
- `<scope>` — область изменения:
  - `app-<app>` (например, `app-web`) для изменений в `apps/*`
  - имя модуля из `src/Module/*` (например, `Source`) для изменений в модуле
  - для прочих директорий (например, `docs/*`, `devops/*`) — короткая метка по месту правки (например, `git-workflow`, `devops`)
- `<subject>` — описание намерения (intent) на английском и русском через косую черту, в повелительном наклонении (imperative).

### Допустимые типы (type)

- `fix` — исправление ошибки (bug fix)
- `feat` — новая функциональность (new feature)
- `build` — изменения в системе сборки или внешних зависимостях
- `chore` — рутинные задачи (обновление зависимостей, конфигураций и т.д.)
- `ci` — изменения в CI/CD конфигурациях
- `docs` — изменения в документации
- `style` — изменения форматирования кода (не влияющие на логику)
- `refactor` — рефакторинг кода без изменения функциональности
- `perf` — улучшения производительности
- `test` — добавление или изменение тестов
- `revert` — отмена предыдущего коммита

### Области (scope)

Scope указывает на область изменения, в качестве scope используем укрупненное место правки (это может быть имя приложения в apps/, либо имя модуля в src/Module), примеры:

#### Приложения (app-*)
- `app-api` — изменения в `apps/api/`
- `app-blog` — изменения в `apps/blog/`
- `app-console` — изменения в `apps/console/`
- `app-doc` — изменения в `apps/doc/`
- `app-web` — изменения в `apps/web/`

#### Модули
- `AppOption` — изменения в `src/Module/AppOption/`
- `Attribution` — изменения в `src/Module/Attribution/`
- `Billing` — изменения в `src/Module/Billing/`
- `Chat` — изменения в `src/Module/Chat/`
- `Llm` — изменения в `src/Module/Llm/`
- `Project` — изменения в `src/Module/Project/`
- `Source` — изменения в `src/Module/Source/`

#### Прочие области (для общих директорий)

Для изменений в директориях вне `apps/` и `src/Module/` используйте короткие метки по месту правки:

- `git-workflow` — изменения в документации git workflow (`docs/git-workflow/`)
- `devops` — изменения в devops скриптах и конфигурациях (`devops/`, `compose.yaml`)

> **Примечание:** Использование в качестве scope имен из раздела "### Допустимые типы (type)" не допустимо.

## Правила для subject

- Начинается со строчной буквы
- Не заканчивается точкой
- Не содержит двоеточий (`:`)
- Краткое и понятное описание
- На английском и русском языке через косую черту (формат: `английский текст / русский текст`)
- В повелительном наклонении (imperative)
- Без "заглушек" и бессодержательных формулировок

> **Примечание:** Двоеточие в subject создаёт путаницу с форматом коммита `<type>(<scope>): <subject>`. Используйте другие разделители (например, косую черту `/` или запятую `,`), если нужно перечислить несколько элементов.

## Правила для коммитов

- Сообщения коммитов — строго по **Conventional Commits**.
- Не смешивай в одном коммите разные типы изменений.
- Не смешивай в одном коммите поведение и форматирование.
- Не смешивай `move/rename` и `refactor/behavior change` в одном коммите.
- Используй `git commit -m ...` без генераторов.

## Примеры

- `feat(Source): add refresh request endpoint / добавить эндпоинт на обновление`
- `fix(app-web): prevent double submit on refresh / предотвратить двойную отправку при обновлении`
- `docs(git-workflow): describe code review workflow / описать процесс code review`
- `refactor(Rag): extract document type resolver / извлечь резолвер типа документа`
- `feat(Source): add PDF document support / добавить поддержку PDF-документов`
- `fix(Billing): fix currency calculation / исправить расчёт валюты`

## Breaking changes

- Используйте `!` в заголовке (`feat!:`/`fix!:`).
- Или добавьте блок `BREAKING CHANGE:` в теле коммита.

## Валидация

Проект использует автоматическую валидацию коммитов через:

1. **Git hooks** — валидация выполняется при каждом коммите
2. **CI** — валидация выполняется в GitHub Actions

### Установка git hooks

```bash
make git-hooks
```

Эта команда устанавливает хуки для автоматической валидации сообщений коммитов при каждом коммите.

### Обход валидации (только для экстренных случаев)

```bash
git commit --no-verify -m "your commit message"
```

⚠️ Используйте `--no-verify` только в исключительных случаях!

## Помощь при создании коммитов

Для помощи в создании правильного сообщения коммита используйте:

```bash
make prepare-commit
```

Эта команда:
- Предлагает выбрать тип коммита
- Предлагает выбрать область (scope)
- Проверяет subject на соответствие правилам
- Генерирует готовое сообщение коммита

Используйте эту команду для помощи в создании правильного сообщения коммита, особенно если вы не уверены в формате или хотите избежать ошибок валидации.

## Алгоритм создания коммита

1. Выбери `<type>`.
2. Выбери `<scope>`.
3. Сформулируй `<subject>`.
4. Создай коммит: `git commit -m "<type>(<scope>): <subject>"`.

## Дополнительные ресурсы

- [Conventional Commits Specification](https://www.conventionalcommits.org/)
- [How to Write a Git Commit Message](https://chris.beams.io/posts/git-commit/)
