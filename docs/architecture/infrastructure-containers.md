# Контейнеризация инфраструктуры (Containerized Stack)

В проекте TasK окружения разработки (`dev`), тестирования (`test`) и сквозного тестирования (`e2e`) полностью контейнеризированы. Это обеспечивает идемпотентность среды и гарантирует, что код ведет себя идентично на локальной машине разработчика и в CI-пайплайнах.

## Архитектура конфигурации

Управление инфраструктурой строится на композиции нескольких YAML-манифестов:

- **`compose.yaml`**: Базовая декларация сервисов, общих для всех окружений.
- **`compose.qdrant.yaml`**: Опциональный слой (профиль `qdrant`) для внешних инструментов.
- **`compose.e2e.yaml`**: Полностью изолированный стек с собственным пространством имен (project-name: `task-e2e`).

---

## Список сервисов по окружениям

### 1. Окружение разработки (Development, профиль `dev`)
Основной стек для локальной разработки. Описан в **`compose.yaml`**.

- **`traefik`**: Edge-proxy и Ingress-контроллер. Отвечает за маршрутизацию внешнего трафика, SSL/TLS termination и Dashboard.
- **`nginx`**: Веб-сервер. Обслуживает статику и проксирует FastCGI-запросы в PHP-FPM.
- **`php-fpm`**: Контейнер среды выполнения (PHP 8.4-FPM). Содержит ядро Symfony и бизнес-логику приложений `web` и `api`.
- **`worker-cli`**: Consumer-контейнер для обработки асинхронных задач (Symfony Messenger). Включает тяжелые зависимости (OCR, PDF-утилиты) для пайплайна обработки.
- **`database`**: PostgreSQL с расширением `pgvector` для эффективного хранения и поиска по векторным эмбеддингам.
- **`rabbitmq`**: Брокер сообщений (AMQP). Обеспечивает связь между приложением и воркерами.
- **`minio`**: Объектное хранилище (S3-compatible). Единая точка хранения для всех бинарных артефактов.
- **`minio-init`**: Sidecar для автоматической настройки бакетов и политик в MinIO.
- **`mercure`**: Hub для Real-time уведомлений через протокол Server-Sent Events (SSE).
- **`mailer`**: Mailpit. SMTP-заглушка с Web-интерфейсом для отладки почты.

### 2. Окружение тестирования (Testing, профиль `test`)
Используется для запуска Unit и Integration тестов. Описано в **`compose.yaml`**.

- **`php-test`**: Оптимизированный контейнер для запуска PHPUnit. Настроен аналогично `php-fpm`, но с оптимизациями для быстрого прогона тестов в окружении `APP_ENV=test`.

### 3. Окружение сквозного тестирования (End-to-End, проект `task-e2e`)
Полностью изолированный стек. Описан в **`compose.e2e.yaml`**.

- **`database` (e2e)**: Изолированная БД для E2E сценариев.
- **`rabbitmq` (e2e)**: Изолированный брокер сообщений для E2E.
- **`mailer` (e2e)**: Mailpit для E2E проверки отправленных email (SMTP sink + Web UI).
- **`mercure` (e2e)**: Изолированный Mercure hub для проверки Real-time событий.
- **`php-fpm` (e2e)**: Экземпляр приложения, работающий в E2E среде (`APP_ENV=e2e`).
- **`nginx` (e2e)**: Веб-сервер для доступа браузера к приложению.
- **`worker-cli` (e2e)**: Воркеры, обрабатывающие задачи именно из E2E очередей.
- **`test-runner`**: Координатор, запускающий PHPUnit и управляющий процессом тестирования.
- **`selenium`**: Standalone Chrome сервер. Позволяет Panther запускать реальный браузер для проверки JS и UI.

### 4. Внешние инструменты (External Tooling)
Описаны в **`compose.qdrant.yaml`**.

- **`qdrant`**: Векторная база данных. Используется исключительно внешними ИИ-агентами (например, Kilo Code) для индексации кода проекта. Не является частью бизнес-логики TasK.

---

## Эксплуатация и управление (Makefile)

**Важнейшее правило**: Взаимодействие с контейнерами должно происходить **исключительно** через `make` команды.

`Makefile` инкапсулирует сложность:
1. Автоматически прокидывает префикс проекта `-p task` (или `-p task-e2e`).
2. Подключает нужные `.env` файлы (включая `.local`).
3. Управляет комбинацией Compose-файлов и профилей.

**Примеры команд:**
| Команда | Действие |
|:---|:---|
| `make up` | Поднять стек разработки (dev) в фоне |
| `make stop` | Остановить контейнеры dev |
| `make down` | Полная очистка всех ресурсов (удаление сетей, томов и сирот) |
| `make build` | Форсированная сборка образов |
| `make tests-e2e-filter TEST_FILTER=...` | Запуск конкретного E2E сценария в изолированной среде |
