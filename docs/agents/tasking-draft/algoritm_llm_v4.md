# Алгоритм постановки задачи LLM (v4)

Этот алгоритм основан на лекциях «Команда и инструменты управления», правилах проекта **TasK** и профиле агента **Codex
**. Он поможет формулировать задачи для AI‑моделей таким образом, чтобы результат был полезным, проверяемым и
соответствовал стандартам проекта. Приведены пояснения, потенциальные риски и ссылки на соответствующие правила.

## 1. Определите контекст и окружение

- **Бизнес‑цель и место фичи.** Сформулируйте, зачем нужна новая функция или исправление и каким пользователям/процессам
  она служит. Это позволяет сохранять общий фокус команды и помогает модели понимать, чего от неё ждут.
- **Техническое окружение.** Укажите версии языка и фреймворков (например, PHP 8.3, Symfony 7.3, версия Bootstrap) и
  целевые браузеры. Codex в профиле прямо просит уточнять версии и окружение, чтобы ответы были
  актуальными. Уточните, в каком модуле и слое Domain‑Driven Design (Domain, Application,
  Infrastructure, Integration) будет работать код — в проекте TasK строгое разделение на слои является ключевым
  принципом.
- **Связанные контракты.** Если задача меняет публичный API (DTO, события), обязательно укажите соответствующие классы и
  необходимые обновления в документации.

## 2. Опишите образ результата и критерии приёмки

- **SMART‑формулировка.** Задача должна описывать завершённый результат (функцию, класс, тест, документ) с измеримыми
  критериями, достижимыми в заданный срок.
- **Архитектурные требования.** Определите, в каком слое и модуле должен появиться код. Соблюдайте жёсткую модульную
  изоляцию: взаимодействие между слоями допускается только через публичные интерфейсы.
- **Тесты и статический анализ.** В проекте TasK каждое изменение сопровождается юнит‑тестами и/или интеграционными
  тестами, покрытие новых участков кода должно быть не ниже 80 %. Перед коммитом необходимо
  запускать `make psalm`, `make phpcs`, `make tests-unit`, `make audit` и `make deptrac` — все проверки должны
  завершаться без ошибок. Это нужно явно указать в критериях приёмки.
- **CI/CD‑критерии.** Опишите, какие команды должны пройти успешно (`make check`, «conventional commits prepare» и т.
  п.), и какой уровень покрытия будет приемлем. Укажите, что пулреквест не примут, если покрытие снизится или какие‑то
  проверки упадут.

## 3. Предоставьте ресурсы и ссылки

- **Код и конфигурация.** Покажите фрагменты существующего кода, конфиги и структуру проекта, чтобы Codex мог опираться
  на текущую реализацию. Профиль Codex рекомендует предоставлять исходный код и структуру проекта для устранения
  неоднозначности.
- **Документация и задачи.** Дайте ссылки на связанные документы (например, `AGENTS.md`, `docs/conventions`,
  `docs/agents/codex/PROFILE.md`), страницу задачи или issue. Это поможет модели найти примеры и соблюдать правила
  проекта.
- **Версии и зависимости.** Укажите версии пакетов и зависимости, которые нельзя обновлять/использовать.

## 4. Определите шаги и режим выполнения

- **Декомпозиция.** Разбейте задачу на этапы: анализ контекста, дизайн API, реализация, написание тестов, рефакторинг.
  Это соответствует курсовому алгоритму (обсуждение, формулировка результата, шаги, проверка понимания).
- **Режим генерации.** Уточните, нужен ли «каркас» (skeleton) или полностью рабочая реализация, хотите ли вы видеть
  пояснения и комментарии. Codex может создавать как минималистичные решения, так и более подробные версии.
- **Интерация.** Предусмотрите точки контроля: сначала модель высылает план или псевдокод, после согласования — пишет
  код, затем тесты. Такой итеративный подход уменьшает число переделок.

## 5. Контроль и обратная связь

- **Промежуточные проверки.** Назначьте даты/время для синхронизаций (или просто укажите шаг, после которого необходимо
  показать промежуточный результат). Например: «После того как ты разработаешь API и тесты, пришли их на проверку,
  прежде чем реализовывать бизнес‑логику».
- **Проверка понимания.** Попросите модель пересказать задачу или составить план: это позволяет вовремя скорректировать
  трактовку задачи и выявить пробелы.
- **Обратная связь.** Описывайте замечания конкретно и по пунктам; при необходимости корректируйте параметры (сроки,
  критерии, порядок шагов).

## 6. Коммиты, документация и PR

- **Conventional Commits.** Все коммит‑сообщения должны соответствовать стандарту Conventional Commits — их можно
  сгенерировать через `vendor/bin/conventional-commits prepare`. Тип коммита (feat, fix,
  refactor и т. д.) должен отражать природу задачи, как показано в `todo`.
- **Один PR — одна задача.** Не объединяйте разные типы изменений (feature, bugfix, refactor) в одном
  пулреквесте. Ветки и названия PR следует писать на английском.
- **Документация.** При изменении публичного API, слоёв или контрактов обязательно обновляйте документацию и комментарии
  в коде. Помечайте временные решения тегами `@todo` или `@techdebt` с датой и
  объяснением.

## 7. Риски и частые ошибки

| Риск/ошибка                    | Описание                                                                                                          | Как избежать                                                                          |
|--------------------------------|-------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------|
| **Отсутствие контекста**       | Задача сформулирована без указания версий, окружения или существующего кода, что приводит к неподходящему решению | Всегда указывайте версии, фрагменты кода и цели задачи                                |
| **Нарушение архитектуры DDD**  | Разработка вне нужного модуля/слоя или прямой вызов из Infrastructure в Domain                                    | Определяйте модуль и слой заранее; соблюдайте принцип модульной изоляции              |
| **Нет тестов / покрытие <80%** | Изменения без достаточного тестирования отклоняются                                                               | Включайте юнит‑ и интеграционные тесты, указывайте порог покрытия                     |
| **Пропущенные проверки**       | Пропуск `psalm`, `phpcs`, `deptrac`, `audit` приведёт к ошибкам в CI                                              | Добавьте эти команды в критерии приёмки и убедитесь, что Codex запускает `make check` |
| **Смешение разных изменений**  | Объединение feature/refactor/tests усложняет ревью и нарушает правила                                             | Формулируйте и выполняйте одну логическую задачу на PR                                |
| **Сокрытие временных решений** | Костыли без пометки `@todo`/`@techdebt` портят качество кода                                                      | Всегда документируйте временные решения с датой и пояснением                          |

## 8. Пример применения

Допустим, в `todo` есть задача:

```
## [ ] feat: implement tag system
Описание: создать возможность добавлять тэги к проектам и чатам. Реализовать CRUD интерфейсы и связывание тегов в UI.
```

Постановка для Codex может выглядеть так:

1. **Контекст и окружение:**
    - Цель: пользователи смогут организовывать проекты и чаты с помощью тегов для быстрого поиска и фильтрации.
    - Техническое окружение: PHP 8.3, Symfony 7.3, Bootstrap 5 Phoenix. Модуль: `Tag`, слой: Application/Infrastructure.
    - Ветка: `task/implement-tag-system`. Тип коммита: `feat`.
2. **Образ результата и критерии:**
    - Создать модуль `Tag` в каталоге `src/Module/Tag` с сущностью Tag, CRUD UseCase, контроллер, Form/DTO.
      Предусмотреть связь Many‑to‑Many с проектами и чатами.
    - Реализовать CRUD страницы в UI, используя Symfony UX. Обеспечить корректную работу с Bootstrap 5 Phoenix.
    - Критерии приёмки: покрытие тестами ≥80 %, `make psalm`, `make phpcs`, `make tests-unit`, `make audit`,
      `make deptrac` проходят без ошибок; ветка содержит только реализацию этой фичи; сообщения коммитов — Conventional
      Commits.
3. **Ресурсы:**
    - Схема текущей базы данных (см. `src/Module/*/Domain/Model`).
    - Примеры CRUD UseCase в других модулях (например, `src/Module/User`).
    - Ссылки на `AGENTS.md` и `docs/conventions/principles/values.md` для соблюдения архитектуры.
4. **Шаги и контроль:**
    - Предложи план из 3–5 шагов: создание сущности и миграции, разработка UseCase, реализация контроллеров и форм,
      написание тестов, обновление UI.
    - После формирования плана я его утвержу. Затем реализуй код и тесты. На каждом этапе присылай промежуточный
      результат.
5. **Коммиты и PR:**
    - После завершения работы запусти `make check`. Если всё успешно, создай PR с веткой `task/implement-tag-system`. В
      описании PR укажи цель и основные изменения.

Такая структура помогает Codex понять задачу, соблюсти архитектурные правила и подготовить проверяемый результат.
