# Метрики и статистика использования AI-агентов

В этом документе описывается процесс сбора статистики и анализа эффективности использования AI-агентов (Gemini, Claude, etc.) в проекте.

## Цель
Отслеживание динамики продуктивности разработки с использованием ИИ. Основная задача — минимизировать количество итераций (правок) на одну задачу, повышая качество контекста и промптов.

## Инструменты сбора статистики

### 1. Общая статистика по репозиторию
Скрипт `bin/stat-by-week.sh` собирает данные из `git log` по неделям.
*   **Метрики:** Добавленные/удаленные строки, количество коммитов, количество измененных файлов.
*   **Фильтрация:** Исключает автогенерируемые файлы (Phoenix assets, public, styles и т.д.).
*   **Команда:**
    ```bash
    bin/stat-by-week.sh
    ```

### 2. Статистика по PR агентов
Скрипт `bin/agent-prs-by-week.sh` использует GitHub CLI (`gh`) для анализа смерженных PR с определенной меткой (например, `gemini-cli`).
*   **Метрики:** Количество PR, добавленные/удаленные строки, количество измененных файлов.
*   **Команда:**
    ```bash
    bin/agent-prs-by-week.sh <agent-label>
    # Пример:
    bin/agent-prs-by-week.sh gemini-cli
    ```

## Таблица метрик
Данные агрегируются в [Google Sheets](https://docs.google.com/spreadsheets/d/1Tk2QYgTibHpEGGAKRd-n5xvilLVly2_pThQh5NSPvhs/edit?usp=sharing).

### Основные метрики:
*   **Lines Added/Deleted:** Объем кода.
*   **PR Count:** Количество завершенных задач.
*   **Commits per PR:** (Вычисляемая) Среднее количество коммитов в одном PR.

## Проблематика метрики "Commits per PR"
Текущая метрика "Commits per PR" показывает значения 1-3, что является "Ложноположительным" показателем качества, так как:
1.  **Локальные итерации:** Основная работа по исправлению замечаний происходит локально (в IDE) до пуша в репозиторий.
2.  **Сквош коммитов:** Агенты могут изменять существующие коммиты или пользователь делает squash перед мержем.

В результате метрика отражает **чистоту истории**, а не **количество итераций "Промпт -> Правка"**.

## Мозговой штурм: Проблема учета итераций

Текущая проблема: Метрика `Commits per PR` не отражает реальное количество итераций (Prompt -> Code -> Fix), так как правки часто вносятся локально без коммитов, чтобы сохранять удобный `git diff` в IDE.

### Идея 1: Принудительные WIP Коммиты (Dirty Commits) — ПРИОРИТЕТНАЯ
Агент делает коммит и ПУШИТ изменения при каждой итерации правок.
*   **Плюсы:**
    *   Точная статистика итераций через стандартный `git log` (1 коммит = 1 итерация).
    *   "Zero Trust" — не нужно полагаться на честность агента.
*   **Минусы:**
    *   **Расход токенов:** Незначительное увеличение расхода на выполнение дополнительных команд (`git commit`, `git push`) и обработку их вывода.
    *   **Время:** Агент тратит время на выполнение сетевых операций (push).
*   **Процесс Ревью:**
    *   Пользователь смотрит Diff в **GitHub UI** (так как изменения запушены).
    *   Либо в IDE через **"Compare with Branch (master)"**.
*   **Финал:** Merge Request сливается через **Squash**, превращая историю попыток в один чистый коммит.

### Идея 2: Мета-данные в описании PR
Агент или пользователь добавляет спец-блок в описание PR: `<!-- AI-STATS: iterations=5 -->`.
*   **Плюсы:** Чистая история git; привычный процесс работы в IDE.
*   **Минусы:** "Human/Agent Factor" — агент может забыть, соврать (галлюцинация) или ошибиться в подсчетах. Требует доверия к агенту.

### Идея 3: Внешний файл-счетчик
Скрипт-обертка (runner) инкрементирует счетчик в локальном файле `.agent_attempts` (gitignored) при каждом обращении к LLM.
*   **Плюсы:** Полная автоматизация; не зависит от git; не зависит от промптов.
*   **Минусы:** Требует доработки среды запуска (IDE плагина или CLI-обертки), а не самого агента.
