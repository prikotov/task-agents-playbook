# Аутентификация через OAuth

В проекте для реализации входа через социальные сети используется [KnpUOAuth2ClientBundle](https://github.com/knpuniversity/oauth2-client-bundle?tab=readme-ov-file). Этот бандл упрощает интеграцию с различными OAuth2-провайдерами.

## Ключевые файлы конфигурации

Ниже перечислены основные файлы, отвечающие за настройку и работу OAuth-аутентификации в проекте:

- **Конфигурация бандла:** `apps/web/config/packages/knpu_oauth2_client.yaml`
  - *Здесь определяются все провайдеры (Google, Yandex и т.д.) и их базовые параметры.*

- **Переменные окружения:** `.env`
  - *Шаблон для всех переменных окружения, включая `CLIENT_ID` и `CLIENT_SECRET` для каждого провайдера.*

- **Локальные секреты:** `.env.local`
  - *В этом файле (который не хранится в Git) вы указываете ваши реальные `CLIENT_ID` и `CLIENT_SECRET`.*

- **Классы-аутентификаторы:** `apps/web/src/Security/`
  - *Логика для каждого провайдера (например, `GoogleAuthenticator.php`). Здесь происходит обработка данных пользователя после успешного входа.*

- **Определение маршрутов:** `apps/web/src/Module/User/Route/AuthRoute.php`
  - *Здесь задаются пути для callback-URL (например, `/user/auth/google/check`), которые нужно указывать в настройках провайдеров.*

## Инструкции по настройке

- [Подключение Google OAuth](google-oauth-setup.md)
- [Подключение Yandex OAuth](yandex-oauth-setup.md)

## Песочницы (Sandbox)

Основной Development-экземпляр проекта `task` уже настроен для входа через внешние провайдеры. Песочницы копируют общую
конфигурацию, но их домены отсутствуют в списках разрешённых redirect URI, поэтому социальные логины там не работают
«из коробки».

Чтобы активировать OAuth в конкретной песочнице:

1. Добавьте redirect URI вида `https://{sandbox}.task.localhost:8443/user/auth/{provider}/check` в настройках
   соответствующего OAuth-клиента (Google, Yandex и т.д.) в консоли провайдера.
2. Пропишите `CLIENT_ID`, `CLIENT_SECRET` и путь к JSON/секретам провайдера в `.env.dev.local` песочницы.
3. Поместите скачанные секреты (например, `client_secret_*.json`) в директорию `secrets/` внутри песочницы. Каталог
   исключён из Git, поэтому данные не попадут в репозиторий.

Без этих шагов вход через социальные сети вернётся с ошибкой (например, `invalid_request` у Google) из-за
несогласованного redirect URI.
