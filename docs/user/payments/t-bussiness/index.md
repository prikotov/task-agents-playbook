# Интеграция с платежным сервисом T‑Банк (Т‑Бизнес)

Раздел содержит описание подключения платежей через сервис [Т‑Банк. Прием платежей](https://www.tbank.ru/kassa/dev/payments/). В продукте реализована интеграция через платежный виджет согласно [документации по интеграции через JavaScript](https://www.tbank.ru/kassa/dev/integrationjs/).

Интеграция реализована компонентом `Common\\Module\\Billing\\Integration\\Component\\TBusiness\\TBusinessPaymentsComponent`, который отвечает за взаимодействие с Merchant API.

## Проверка статуса платежей

Статус платежей автоматически обновляется консольной командой `app:billing:payment:check-state`. Команда помечена атрибутом `#[AsCronTask('*/10 * * * *')]`, поэтому Symfony Scheduler запускает её каждые 10 минут.

Подробные инструкции по запуску воркера планировщика доступны в разделе [«Планировщик задач»](../../deploy/setup-worker-production/scheduler.md).

## Тестовые карты

Для проверки платежного процесса используйте тестовую среду виджета и специальные карты. Полный перечень сценариев доступен в [официальной документации](https://www.tbank.ru/kassa/dev/payments/). Ниже приведены наиболее распространенные примеры:

| Номер карты        | Поведение                                           | Дополнительно                |
|--------------------|------------------------------------------------------|------------------------------|
| `2201382000000013` | Успешная оплата по 3‑DS 2.0 без ввода пароля        | exp: `12/25`, CVC: `123`     |
| `2201382000000047` | Успешная оплата, требуется ввод OTP `1qwezxc`      | exp: `12/25`, CVC: `123`     |
| `2201382000000831` | Недостаточно средств                                | exp: `12/25`, CVC: `123`     |
| `2201382000000021` | Ошибка при списании                                 | exp: `12/25`, CVC: `123`     |
| `2200770239097761` | Успешная оплата без 3‑DS                            | exp: `12/25`, CVC: `123`     |

> Для остальных сценариев (Challenge flow, ошибки аутентификации и т.д.) обращайтесь к официальному руководству.

## Отмена рекуррентных платежей

На момент подготовки документации у T‑Банка отсутствует публичный API-метод для отключения рекуррентных платежей. Мы
храним признак автоплатежа в профиле пользователя и после его отключения прекращаем инициировать новые списания. При
изменении требований со стороны банка интеграция может быть дополнена отдельным вызовом, который будет отзывать `RebillId`
или аналогичный идентификатор на стороне T‑Банка.
