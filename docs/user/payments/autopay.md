# Ежемесячное автосписание через Т‑Банк

Автосписание пополняет баланс пользователя один раз в месяц, если средств недостаточно для минимального платежа по тарифу. Описанный процесс относится к тарифам с включённым автопополнением и рекуррентным платежам через Т‑Банк.

## Условия запуска

Автоплатёж инициируется только когда выполняются все условия:

- **Включено автосписание в профиле пользователя.** Флаг включается при оплате тарифа и сохраняется в профиле.
- **Текущий тариф требует автопополнения** (`requiresAutoTopUp = true`) и имеет положительное значение `minMonthlyCharge`.
- **Валюта тарифа — RUB.** Для других валют автосписание не выполняется.
- **Баланс меньше минимального платежа.** Если средств хватает, повторное списание не инициируется.
- **Есть успешный рекуррентный платёж за предыдущий месяц.** Новый платёж создаётся не ранее чем через 1 месяц после последнего успешного списания.
- **Сохранён `RebillId` и `PaymentId` последнего платежа.** Эти значения возвращаются Т‑Банком и позволяют выполнить повторное списание.

Если хотя бы одно условие не выполняется (например, отсутствует `RebillId` или тариф был изменён на план без автопополнения), задача пропускает пользователя до следующего запуска.

## Расписание

Команда `app:billing:autopay:process` помечена как cron-задача с расписанием `0 4 * * *`, поэтому запускается каждый день в 04:00 по времени сервера. При каждом запуске команда проверяет всех пользователей с включённым автосписанием и выбирает тех, кто соответствует условиям выше. Повторное списание создаётся только после того, как с момента последнего успешного платежа прошёл полный календарный месяц.

## Роль RebillId

`RebillId` передаётся Т‑Банком после первой успешной оплаты через виджет. Значение сохраняется вместе с идентификаторами платежа и используется для повторных списаний. Без сохранённого `RebillId` автосписание не запускается — в логах появится запись «rebill id missing». Чтобы восстановить автоплатёж, пользователю нужно повторно оплатить тариф через виджет и сохранить новый токен.

## Как отключить автоплатёж

Автосписание можно выключить в интерфейсе: перейдите в раздел «Биллинг → Отмена подписки» (`/billing/subscription/cancel`) и отправьте форму отключения. После этого новые рекуррентные списания выполняться не будут, но доступ сохранится до конца уже оплаченного периода. При повторной оплате тариф автоматически активирует автосписание и сохранит новый `RebillId`.

## Дополнительные заметки

- Если на стороне банка токен отозван, автоплатёж завершится ошибкой. В этом случае пользователь получит стандартное уведомление о неуспешном списании, а следующий запуск снова попытается выполнить платёж.
- Для ручной проверки сценария можно запустить команду локально: `php bin/console app:billing:autopay:process` или передать UUID конкретного пользователя в аргументе.
